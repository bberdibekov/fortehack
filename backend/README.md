**A Service-Oriented Agentic Architecture for Automated Business Analysis.**

This is the backend engine for the Intelligent Business Analyst. It transforms the experience from a passive "Chatbot" into an **Active Project Co-Pilot**. It combines a "Living Ledger" state machine with a **Bi-Directional Synchronization Protocol** to ensure the AI and Human are always working on the exact same requirements.

---

## üöÄ How It Drives Project Success

Unlike standard RAG bots that wait for prompts, this system **drives the project to completion**.

### 1. Active Elicitation ("The Analyst Mindset")
The `Orchestrator` uses dynamic heuristics‚Äînot templates‚Äîto analyze the gap between the current state and a complete specification.
*   **The "Up To 3" Rule:** Instead of slow ping-pong, the agent asks **up to 3 focused questions** to clear ambiguity (e.g., "Who approves?", "What if it fails?", "What is the KPI?").
*   **The Exit Ramp:** It knows when to stop. If the spec is solid (Happy Path + Exceptions + Roles + Goals), it stops asking questions and proposes **Publishing** the documentation.

### 2. The Visual Verification Loop ("Show, Don't Just Tell")
The system enforces a strict feedback loop:
*   **Trigger:** Every time business facts change, the backend automatically triggers `Mermaid`, `User Story`, `Workbook`, and `Use Case` agents.
*   **Anchor:** The Agent explicitly directs the user's attention: *"I've mapped the decision point in the **Process Flow**. Does that logic match reality?"*
*   **Result:** This anchors the conversation in concrete artifacts, reducing hallucinations and misunderstandings.

### 3. Enterprise-Grade Specification
Beyond simple "chat," the system captures the full dimensions of a BRD:
*   **Data Dictionary:** Auto-extracts entities and fields (e.g., "Loan Application" contains `SSN`, `Amount`).
*   **NFRs:** Captures Non-Functional Requirements (Security, Performance, Compliance) separate from business logic.
*   **Compliance Safety Net:** Runs RAG-based checks against banking policies in the background.

---

## üß† The Core Differentiator: Bi-Directional Sync

The system implements a robust **Circular Data Flow** that treats Manual Edits and AI Generation as equals.

### üîÑ Forward Sync (Context Injection)
When the AI regenerates an artifact, it **reads the previous version first**.
*   **Scenario:** You manually change a User Story estimate to `13 SP` in the UI.
*   **Action:** You ask the AI: "Add a story for the login page."
*   **Result:** The AI generates the new story *AND* preserves your manual `13 SP` edit. **Manual work is never lost.**

### üîÑ Reverse Sync (Upstream Propagation)
When you manually edit a document in the UI, the backend parses your changes and **updates the Global Ledger**.
*   **Scenario:** You edit a Use Case to say: *"Primary Actor: **Compliance Officer**"*.
*   **Action:** The Backend strategies (`/services/edit_strategies`) detect that "Compliance Officer" is a new role.
*   **Result:** The Global Actor List is updated. Subsequent diagrams generated by the AI automatically include the Compliance Officer lane.

---

## ü§ñ The Agent Roster

The system uses a **Multi-Agent Orchestrator** pattern. Each agent is a specialized worker responsible for a specific domain.

| Agent | Responsibility | Output Type |
| :--- | :--- | :--- |
| **Orchestrator** | **The Manager.** Manages state, routes messages, runs the Gap Engine, and drives the ReAct loop. | `WebSocket Events` |
| **Extractor** | **The Listener.** Filters noise. Extracts Requirements, Data Entities, and NFRs. Normalizes roles. | `Ledger Updates` |
| **Checker** | **The Auditor.** Runs RAG-based compliance checks against policies. | `ComplianceReport` |
| **Analyst** | **The Scrum Master.** Generates User Stories with acceptance criteria. | `StoryArtifact` |
| **Mermaid** | **The Architect.** Visualizes process flows, sequence diagrams, and state machines. | `MermaidArtifact` |
| **Workbook** | **The Scribe.** Maintains the tabular Analyst Workbook (Scope, Goals, Data, NFRs). | `WorkbookArtifact` |
| **Use Case** | **The Formalist.** Generates structured Use Cases with pre/post-conditions. | `UseCaseArtifact` |

---

## üèóÔ∏è Architecture Overview

The system follows **Clean Architecture** principles with a strict separation of concerns.

```ascii
[ Frontend ] <===(WebSocket)===> [ Orchestrator ]
                                       |
           +---------------------------+---------------------------+
           |                           |                           |
   [ Tool Registry ]           [ State Manager ]           [ Artifact Strategies ]
           |                           |                           |
    +------+------+             [ Repository ]           +---------+---------+
    |             |                    |                 |                   |
[Updater]    [Visualizer]       [ In-Memory DB ]    [ Mapper ]          [ Parser ]
                                                        |                   |
                                                  (Outbound JSON)     (Inbound Edit)